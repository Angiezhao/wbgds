<!DOCTYPE html>
<html>
<head>
    <title>World Bank Global Development Sprint, Version 10</title>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script></head>
<body>

<!-- ********************************************************************* version code begins ** -->
<!--<script src="http://use.edgefonts.net/lato.js"></script>-->
<!--<script charset="utf-8" src="http://d3js.org/d3.v3.min.js"></script>-->
<script charset="utf-8" src="http://d3js.org/d3.v3.js"></script>

<style>

    html, body {
        padding: 0;
        margin: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        position: relative;
    }

    body {
        font-family: lato, serif;
        font-size: 11px;


    }

    #chart, #sidebar {
        float: left;
        height: 100%;
        position: ;
        overflow: hidden;
        background: linear-gradient(to bottom, rgba(255,255,255,.1) 0%,rgba(255,255,255,.01) 100%);
    }

    #chart {
        width: 100%;

        vertical-align: left;
        position: absolute;
        left:215px;
    }

    #sidebar {
        padding-left: 5px;
        width: 210px;
        box-shadow: -1px 0 6px 1px rgba(0, 0, 0, .2);
        background: linear-gradient(to bottom, rgba(255,255,255,1) 0%,rgba(255,255,255,.1) 100%);
        position:absolute;


    }

    #sidebar a {
        display: block;
        margin-top: -18px;
        margin-bottom: 5px;
        vertical-align: right;
    }

    .axis path,
    .axis line {
        fill: none;
        stroke: none;
        shape-rendering: crispEdges;
    }

    .axis text {
        font-size: 9px;
        fill: #999;
        color: #999;
    }

    .axis .major line {
        stroke: #ddd;
    }

    .y.axis .major line {
        stroke-opacity: .2;
    }

    .title{
        font-size: 1.5em;
    }

    .dot:hover, .legend:hover {
        cursor: pointer;
    }

    .dot circle {
        stroke-width : .5;
    }

    .dotName text {
        color: #888;
        font-weight: bold;
        text-shadow: 0 -2px 3px rgba(255, 255, 255, 1);
    }

    .tooltip {
        padding: .5em;
        background: #fff;
        border: 1px solid #eee;
        width: 150px;
        line-height: 1.5em;
    }

    .legend text {
        text-shadow: 0 1px 2px rgba(255, 255, 255, .8);
    }

    .legend rect {
        fill: none;
        fill-opacity: 0;
    }

    .legend:hover rect,
    .legend.checked:hover rect {
        fill-opacity: .2;
    }

    .legend.checked rect {
        fill-opacity: .4;
    }

</style>


<div id="chart"></div>
<div id="sidebar">
    <h1>Distrubution of Grant Awards in Fiscal Year 2013</h1>
    <a href="http://visualizing.org/sprint/launch/48771" title="fullscreen version" target="_blank">Open in new window</a>
</div>


<script>


"use strict";

/**
 * Vars, Scales, Axies
 */

// ISO metrics for number, but based on current data
var ISO = {
    M : Math.pow(10, 3),
    G : Math.pow(10, 6),
    T : Math.pow(10, 9)
};

// Number Formatting
var th = d3.format(",");

//  Default Color Range
var color = d3.scale.category20();

var chart = d3.select("#chart")
        , widthFull = chart.node().clientWidth || 740
        , heightFull = chart.node().clientHeight || 600
// TODO: left margin should calculate based on country name
        , margin = {top: 10, right: 20, bottom: 20, left: 140}
        , width = widthFull - margin.left - margin.right
        , height = heightFull - margin.top - margin.bottom
        ;

var root, pack, usePack, zfn, dfn, tt,
        countryPoints, countryNames, country;

// Y Scale for Contract Amount
var x = d3.scale.log()
        .range([margin.top, width]);

// Order Countries on X
var y = d3.scale.ordinal()
        .rangeRoundBands([margin.top, height]);

var yAxis = d3.svg.axis()
        .scale(y)
        .tickSize(-width)
        .orient("left");

function xAsixFormat(d) {
    if (d < ISO.M)
        d = d + "M";
    else if (d < ISO.G)
        d = (d / ISO.M) + "G";
    else if (d < ISO.T)
        d = (d / ISO.G) + "T";
    else
        d = th(d);
    return d;
}

var xAxis = d3.svg.axis()
        .scale(x)
        .tickSize(-height)
        .ticks(12, xAsixFormat)
        .orient("bottom");

function toRgba(c, a, fn) {
    c = d3.rgb(c.toString().replace("rgba", "rgb"));
    c = fn ? c[fn]() : c;
    return "rgba(" + [c.r, c.g, c.b, a] + ")";
}

function fill(d) {
    return d.type == -1
            ? "none"
            : toRgba(d.type
            ? d.type == 2
            ? color(d.key)
            : "rgba(236, 246, 255)"
            : color(d["Major Sector"]), .5);
}

function stroke(d) {
    return d.type == -1 || !usePack ? "none" : toRgba(fill(d), .7, "darker");
}

function visibility(d) {
    return x(d.value) > 0 || usePack ? null : "hidden";
}

function displayLength(node) {
    return node.clientWidth
            || node.getComputedTextLength()
            || node.innerText.length;
}

function visName(d) {
    var g = d3.select(this);
    return usePack && displayLength(g.select("text").node()) < d.r * 1.8 ? null : "hidden";
}

function radius(d) {
    return !usePack
            ? !d.values
            ? 3.5
            : 0
            : d.r;
}

function value(d) {
    return d.basevalue;
}

function key(d) {
    return (d["Borrower Country"] || "").split(",")[0];
}

function yPos(d) {
    return !usePack ? y(key(d)) : d.y;
}

function xPos(d) {
    return !usePack ? x(value(d)) : d.x;
}

// Zooming axes
// http://bl.ocks.org/mbostock/3892928
function pos(d) {
    return "translate(" + [xPos(d), yPos(d)] + ")";
}

// default transform for packages
zfn = {s:1, t : [0,0]};

// default transform fo particles
dfn = {s : 1, t : [margin.left , margin.top/2]};

function zoomed(tr) {
    transform(tr);

    svg.attr("transform", "translate(" + (usePack ? [0, 0] : dfn.t) + ")");

    svg.selectAll(".x.axis")
            .call(xAxis.ticks(12, xAsixFormat));

    svg.selectAll(".y.axis, .x.axis")
            .style("display", usePack ? "none" : null);

    countryNames.attr("transform", pos)
            .style("visibility", visName)
    ;

    (!tr
            ? countryPoints
            : countryPoints.transition().delay(375).duration(1500)
            ).attr("transform", pos)
            .style("visibility", visibility)
            .selectAll("circle")
            .style({
                "fill" : fill,
                "stroke" : stroke
            })
            .attr("r", radius)
    ;
}

function correctTranslate(d, s) {
    s = s || 1;
    return [d[0]/s, d[1]/s];
}

function transform(tr) {
    if (usePack && d3.event && d3.event.translate) {
        zfn.s = d3.event.scale;
        zfn.t = correctTranslate(d3.event.translate, zfn.s)
    }

    (!tr ? country : country.transition().duration(1500))
            .attr("transform", "scale(" +
                    (usePack ? zfn : dfn).s  +
                    ")translate(" +
                    (usePack ? zfn.t : [0,0]) +
                    ")");
}

var zoom = d3.behavior.zoom()
                .x(x)
                .translate([-margin.left, 0])
                .on("zoom", zoomed)
                .scaleExtent([Math.E / 100, Math.E])
                .scale(.15)
        , zoomPack = d3.behavior.zoom()
                .on("zoom", transform)
                .scaleExtent([1, 20])
//.scale(.15)
        ;

/**
 * Draw Frame
 */

var svg = chart.append("svg")
                .attr("width", widthFull)
                .attr("height", heightFull)
                .append("g")
                .attr("transform", "translate(" + dfn.t + ")")
                .call(zoom)
        , zl = svg.append("rect")
                .attr("width", widthFull)
                .attr("height", heightFull)
                .style("opacity", 0)
        ;

// Load the data from 2013
//d3.csv("/sites/default/files/data_set/admin/sprint_major-contract-awards-2013.csv", function(error, data) {
d3.csv("sprint_major-contract-awards-2013.csv", function(error, data) {

    function getAll(a, b) {
        return a.concat(b.values);
    }

    function sort(a, b) {
        return a.value - b.value;
    }

    // Nest Borrower Countries into a new Array
    var cData = d3.nest()
                    .key(function(d) {
                        // Convert strings to numbers.
                        d.value = d.basevalue = parseInt(d["Total Contract Amount (USD)"].substring(1));

                        return key(d);
                    })
                    .key(function(d) {
                        color(d["Major Sector"]);
                        return d["Major Sector"];
                    })
                    .entries(data)
                // Filter Countries that has less than 15 contracts
                    .filter(function(d){
                        d.type = 1;
                        return d.values.reduce(function(a, b) {
                            b.type = 2;
                            return a + b.values.length;
                        }, 0) > 15;
                    })
            ;

    root = {key:"", type : -1, values:cData};


    pack = d3.layout.pack()
            .children(function(d) {
                return d.values;
            })
            .padding(2)
            .sort(sort)
            .value(value)
            .size([width + margin.left, height])
    ;

    x.domain(d3.extent(data, value)).nice();
    y.domain(cData.map(function(d) { return d.key; }));

    svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + (height + 10) + ")")
            .call(xAxis)
            .append("text")
            .attr("class", "label")
            .attr("dx", width + margin.right/2)
            .attr("dy", -10)
            .style("fill", "#666")
            .style("text-anchor", "end")
            .text("Total Contract Amount (USD)")
    ;

    svg.append("g")
            .attr("class", "y axis")
            .call(yAxis)
            .selectAll("text")
            .attr("dy", "-.6em")
            .style("text-anchor", "end")
    ;

    // Label for the Filtered Country or Sector.
    var title = svg.append("g")
                    .append("text")
                    .attr("class", "title")
                    .attr("x", width/2)
                    .attr("y", height - 25)
                    .attr("dy", 25)
                    .style("text-anchor", "middle")
                    .text("")
            ;

    /**
     * Draw Dots
     */
    // list of filters, which need apply
    var filterMap = d3.map({});


    tt = d3.helper.tooltip()
            .attr("class", function(d, i) { return d["Major Sector"]; })
            .attr("d", "b")
            .spaceWidth(width)
            .spaceHeight(height)
            .text(function(d, i){
                return [
                    d.type != -1 ? "Country:<b>" : "",
                    d.type == 1 ? d.key : d.type == 2 ? d.values[0]["Borrower Country"] : !d.type ? d["Borrower Country"] : "",
                    !d.type ? "</b><br>Supplier: <b>" : "",
                    !d.type ? d["Supplier Country"] : "",
                    "</b><br>Supplied ($): <b>",
                    th(d.value),
                    d.type == 2 || !d.type ? "</b><br>Sector: <b>" : "",
                    d.type == 2 ? d.key : !d.type ? d["Major Sector"] : "",
                    "</b><br>"
                ].join("");
            })
    ;

    country = svg.append("g");

    countryPoints = country.selectAll(".dot")
            .data(pack.nodes(root))
            .enter()
            .append("g")
            .attr("class", "dot")
        // Call tooltip helper to show information about the Contract
            .call(tt)
    ;
    countryPoints.append("circle");

    countryNames = country.append("g")
            .selectAll(".dotName")
            .data(countryPoints.data().filter(function(d) { return d.type == 1 }))
            .enter()
            .append("g")
            .attr("class", "dotName")
            .call(tt);

    countryNames
            .append("text")
            .attr("dy", ".35em")
            .style("text-anchor", "middle")
            .text(function(d) { return d.key.split(',')[0] })
    ;

    zoomed();

    /**
     * Add Legend
     */
    var hs = height - d3.select("#sidebar").select("h1").node().clientHeight,
            info = d3.select("#sidebar")
                    .append("svg")
                    .attr("width", 205)
                    .attr("height", hs)
                    .append("g")
                    .attr("transform", "translate(5,5)")
            ;

    info.append("text")
            .attr("dy", ".35em")
            .style("opacity", .2)
            .text("Click on items in order to apply filter");

    [{
        values : color.domain(),
        sclass : ".legend",
        c : color,
        tr : function(d, i) { return "translate(0," + (i + 1) * 18 + ")"; },
        click : function(d) {
            var g = d3.select(this);
            if (g.classed("checked")) {
                g.classed("checked", false);
                filterMap.remove(d);
            }
            else {
                g.classed("checked", true);
                filterMap.set(d, true);
            }
            filterL(d);
        }
    }, {
        values : ["Particles", "Packages"],
        sclass : ".legend.itemType",
        classes : function(d, i) { return "legend itemType" + (!i ? " checked" : "");  },
        c : "#888",
        tr : function(d, i) { return "translate(0," + (hs - (i + 1) * 18) + ")"; },
        click : function(d) {
            var g = d3.select(this);
            var tr = g.classed("checked");
            d3.select(this.parentNode)
                    .selectAll(".itemType")
                    .classed("checked", false);
            g.classed("checked", true);

            usePack = d == "Packages";

            // save cur state
            if (!usePack) {
                zfn.s = zoomPack.scale();
                zfn.t = correctTranslate(zoomPack.translate(), zfn.s);
            }

            // change zooming
            svg.call(usePack ? zoomPack : zoom);

            filterL(!tr);
        }
    }].forEach(function(item) {
                var legend = info.selectAll(item.sclass)
                                .data(item.values)
                                .enter()
                                .append("g")
                                .attr("class", item.classes || "legend")
                                .attr("transform", item.tr)
                                .on("click", item.click)
                        ;

                legend.append("rect")
                        .style("fill", item.c)
                        .attr("height", 18)
                        .attr("y", -9)
                        .attr("x", -7);


                legend.append("circle")
                        .attr("cx", 0)
                        .attr("cy", 0)
                        .attr("r", 5)
                        .style("fill", item.c)
                ;

                legend.append("text")
                        .attr("x", 12)
                        .attr("y", 0)
                        .attr("dy", ".35em")
                        .style("text-anchor", "start")
                        .text(function(d) { return d; })
                ;

                legend.shift().forEach(function(g) {
                    g = d3.select(g);
                    g.select("rect")
                            .attr("width",
                                    displayLength(g.select("text").node()) + 20)
                    ;
                });
            });

    /**
     * Filter Functions on Hover
     */

    function filterC(selected) {
        countryPoints
                .style("opacity", .1)
                .filter(function(d) { return key(d) == selected.key; })
                .style("opacity", 1);

        title.text(selected.key);
    }

    function legFilter(d) {
        return d.type == 1 || (d.type == 2 && filterMap.has(d.key)) || filterMap.has(d["Major Sector"]);
    }

    function filterValue(d) {
        return legFilter(d) ? value(d) : 0;
    }

    function filterL(selected) {
        pack.value(filterMap.keys().length > 0 ? filterValue : value)
                .sort(sort)
                .nodes(root, 0)
        ;

        countryPoints
                .style("display", "none")
                .filter(legFilter)
                .style("display", null);

        countryNames
                .style("display", "none")
                .filter(legFilter)
                .style("display", null);

        //title.text(selected);
        if (filterMap.keys().length < 1)
            filterOff(selected);

        zoomed(selected);
    }

    function filterOff(selected) {
        countryPoints
                .style("display", null);

        countryNames
                .style("display", null);

        title.text("");
    }
});

var rsTimer;

function resize() {
    d3.select("#sidebar").style("display", "none");
    widthFull = chart.node().clientWidth || 740;
    heightFull = chart.node().clientHeight || 600;
    width = widthFull - margin.left - margin.right;
    height = heightFull - margin.top - margin.bottom;

    d3.select("#sidebar").style("display", null);
    var hs = height - d3.select("#sidebar").select("h1").node().clientHeight;
    d3.select("#sidebar").select("svg")
            .attr("height", hs)
            .selectAll(".legend.itemType")
            .attr("transform", function(d, i) { return "translate(0," + (hs - (i + 1) * 18) + ")"; })
    ;

    chart.select("svg").attr("width", widthFull)
            .attr("height", heightFull);
    zl.attr("width", widthFull)
            .attr("height", heightFull);

    x.range([margin.top, width]);
    y.rangeRoundBands([margin.top, height]);

    svg.selectAll(".x.axis")
            .call(xAxis.tickSize(-height))
            .attr("transform", "translate(0," + (height + 10) + ")")
            .selectAll(".label")
            .attr("dx", width + margin.right/2);

    svg.selectAll(".y.axis")
            .call(yAxis.tickSize(-width));

    pack && pack.size([width + margin.left, height]).nodes(root);

    tt.spaceWidth(width)
            .spaceHeight(height);

    zoomed();
}

// Resize behavior
d3.select(window).on("resize", function() {
    if (rsTimer) {
        clearTimeout(rsTimer);
        rsTimer = null;
    }
    rsTimer = setTimeout(resize, 300);
});

// Tooltip Helper from
// https://gist.github.com/milroc/2975255
d3.helper = {};

d3.helper.tooltip = function(){
    var tooltipDiv,
            body = d3.select('body'),
            attrs = [],
            text = "",
            styles = [],
            _w, _h;

    function tooltip(selection) {

        function doText(d, i) {
            // Crop text arbitrarily
            tooltipDiv.html(
                    typeof text === "function"
                            ? text(d, i)
                            : typeof text != "undefined" || typeof text != null
                            ? text
                            : ''
            );
        }

        function mover(d, i) {

            var key, name, value;

            // Clean up lost tooltips
            body.selectAll('div.tooltip').remove();

            // Append tooltip
            tooltipDiv = body.append('div');

            for (key in attrs) {
                if (!attrs.hasOwnProperty(key))
                    continue;
                name = attrs[key][0];
                if (typeof attrs[key][1] === "function") {
                    value = attrs[key][1](d, i);
                } else value = attrs[key][1];
                if (name === "class") value += " tooltip";
                tooltipDiv.attr(name, value);
            }
            for (key in styles) {
                if (!styles.hasOwnProperty(key))
                    continue;
                name = styles[key][0];
                if (typeof attrs[key][1] === "function") {
                    value = styles[key][1](d, i);
                } else value = styles[key][1];
                tooltipDiv.style(name, value);
            }
            tooltipDiv.style('position', 'absolute')
                    .style('z-index', 1001);
            mm(d, i);
            doText(d, i);
        }

        function mm(d, i) {
            // Move tooltip
            var absoluteMousePos = d3.mouse(body.node());


            tooltipDiv
                    .style('left', (absoluteMousePos[0] > _w/2
                            ? absoluteMousePos[0] - tooltipDiv.node().clientWidth - 15
                            : absoluteMousePos[0] + 15) + 'px')
                    .style('top', (absoluteMousePos[1] > _h/2
                            ? absoluteMousePos[1] - tooltipDiv.node().clientHeight + 15
                            : absoluteMousePos[1] - 15) + 'px');
            //doText(d, i);
        }

        function mout(d, i){
            // Remove tooltip
            tooltipDiv.remove();
        }

        selection
                .on("mouseover", mover)
                .on('mousemove', mm)
                .on("mouseout", mout);
    }

    tooltip.attr = function(name, value) {
        attrs.push(arguments);
        return this;
    };

    tooltip.text = function(value) {
        text = value;
        return this;
    };

    tooltip.style = function(name, value) {
        styles.push(arguments);
        return this;
    };

    tooltip.spaceWidth = function(value) {
        if (!value) return _w;
        _w = +value;
        return this;
    };

    tooltip.spaceHeight = function(value) {
        if (!value) return _h;
        _h = +value;
        return this;
    };

    return tooltip;
};

</script><!-- ********************************************************************* version code ends ** -->

</body>
</html>